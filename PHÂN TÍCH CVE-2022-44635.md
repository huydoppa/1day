# PHÂN TÍCH CVE-2022-44635

Details : Apache Fineract up to 1.8.0 fileupload + path traversal => RCE

Require : Authenticated 

Author : HuyDoppa

Đầu tiên diff 2 bản 1.8.0 và bản 1.8.1 : 

Có thêm các File để sanitizer => mục đích là để validate mime type và detect path traversal

![image-20221202134832584](C:\Users\nguye\AppData\Roaming\Typora\typora-user-images\image-20221202134832584.png)



Phần application.propoties được thêm các whitelist về đuôi file và mime-type để tránh upload shell

![image-20221202135144856](C:\Users\nguye\AppData\Roaming\Typora\typora-user-images\image-20221202135144856.png)



Đầu tiên đọc docs ta thấy api /clients/{clientId}/images  được dùng để uploadfile

![image-20221202140738570](C:\Users\nguye\AppData\Roaming\Typora\typora-user-images\image-20221202140738570.png)

Mapping với api Controller 

Đoạn code để controller API này

![image-20221202140912491](C:\Users\nguye\AppData\Roaming\Typora\typora-user-images\image-20221202140912491.png)



Điều kiện đầu tiên là check nếu phần enity là 1 trong 2 giá trị clients hoặc staff 

![image-20221202141325148](C:\Users\nguye\AppData\Roaming\Typora\typora-user-images\image-20221202141325148.png)

![image-20221202141339969](C:\Users\nguye\AppData\Roaming\Typora\typora-user-images\image-20221202141339969.png)



Tiếp theo fileUploadValidator.validate(fileSize, inputStream, fileDetails, bodyPart); cái này check xem filesize có lớn hơn 0 , các giá trị kia khác null là đc![image-20221202141653380](C:\Users\nguye\AppData\Roaming\Typora\typora-user-images\image-20221202141653380.png)

2 điều kiện cuối là check filename khác null 

và check nếu mimetype khác gif , png , jpeg

=> Thấy filename ko có filter gì => nếu fileName = payload.jsp và mime/type = image/png vẫn được 

![image-20221202142101360](C:\Users\nguye\AppData\Roaming\Typora\typora-user-images\image-20221202142101360.png)



Trace tiếp vào ImageWritePlatformService.saveOrUpdateImage(hàm 5 đối số ) là 1 interface implements của nó là ImageWritePlatformServiceJpaRepositoryImpl.saveOrUpdateImage(hàm 5 đối số ) 

![image-20221202142404571](C:\Users\nguye\AppData\Roaming\Typora\typora-user-images\image-20221202142404571.png)

Đầu tiên là thực hiện xóa đi ảnh cũ , tiếp tục chạy vào hàm contenRepository.saveImage() 

![image-20221202142905197](C:\Users\nguye\AppData\Roaming\Typora\typora-user-images\image-20221202142905197.png)



Đường dẫn file sẽ nằm trong : System.getProperty("user.home") + File.separator + ".fineract";

Ta thấy giá trị imageName là string cuối cùng được cộng và chúng ta có thể control nó mà k dính filter nào => có thể trigger LFI ở đây

![image-20221202143731960](C:\Users\nguye\AppData\Roaming\Typora\typora-user-images\image-20221202143731960.png)

để trigger được RCE thì cần nhớ về TOMCAT . để deploy được cái code này lên tomcat thì cần build nó thành file war rồi ném vào thư mục webapp của tomcat folder

![Tomcat Directory Structure](https://bhiggs.x10hosting.com/Courses/HighOctaneJava/Servlets/images/Tomcat2.gif)

Và Tomcat có hỗ trợ render jsp nằm trong thư mục webapp/root/*.jsp , Vậy sẽ lợi dụng path traversal để có thể tải file vào thư mục này

![image-20221202145219170](C:\Users\nguye\AppData\Roaming\Typora\typora-user-images\image-20221202145219170.png)



![image-20221202145245332](C:\Users\nguye\AppData\Roaming\Typora\typora-user-images\image-20221202145245332.png)

